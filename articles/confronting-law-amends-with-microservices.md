---
title: "法改正をマイクロサービスで立ち向かう（前編）"
emoji: "🙆"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["microservice"]
published: false
---
:::message
この記事は [LITALICO Engineers Advent Calendar 2021](https://qiita.com/advent-calendar/2021/litalico)の12/15配信になります。
:::

## はじめに

ボリュームが多くなってしまったので前編・後編の2部構成になります。
Engineers Advent Calendarなのでエンジニア向けの記事になります。
ドメイン駆動開発やマイクロサービスといった用語が出てきますが、詳しく知らなくても雰囲気で読める様にしたハズ。 ^[業務で使っていたり、興味を持ってくれている人に読んでもらえると嬉しいです]
前編はテクニカルな話は扱いません。

## 背景とか

LITALICOは障害福祉領域において複数の事業を展開していますが、コア事業として以下の２つがあります。

* 児童福祉法に基づく障害児支援事業
* 障害者総合支援法に基づく就労支援事業

領域は違うものの、その支援内容については各種法令に沿って行われるものとなっています。
今自身が携わっているプロダクトでは前者の障害児支援事業に携わっている事業所さま ^[LITALICO自身も含まれます] 向けの運営支援システムとなります。

運営支援システムはその支援内容にあわせて機能提供を行っており、 給付費の請求業務も含まれます。

給付費請求については馴染みがない人が多いと思いますので軽く補足します。
一番身近な医療をベースで説明すると、お医者さんに掛かった際の医療費は原則3割自己負担分として支払っていらっしゃると思います。
その際に受け取られる診療明細書に点数が書いてあると思いますが、その点数はお医者さんが勝手に決めたものではなく診療報酬制度というもので決めれたものになります。
また、3割支払いされた残りの費用を請求するレセプト業務がそれにあたります。

障害者福祉領域では自己負担が1割だったりしますが、医療と同じように支援内容に応じて点数が `障害福祉サービス等に係る報酬` として定められています。
この定められた点数のことを報酬単位と呼びます。

今回記事として取り上げるのは、この `障害福祉サービス等に係る報酬` が3年に1度大きな改定が行われるのですが、ちょうど今年が法改正のタイミングにあたります。
システム対応するにあたり、どうやって立ち向かっていって乗り越えたか？をお話したいと思います。
複雑なルールが絡み合ったシステムの関心事（今回は法改正というテーマ）をどう紐解いて発展させるか？という一つの事例としてお伝えできれば幸いです。

## 法改正への対応の難しさ

まず法律改正に伴いどう変更があるかのキャッチアップが大変ですw
今回の法改正の資料としては. [こちら](https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/0000202214_00007.html) にまとめられていますが、資料の多くまた記載されている内容もドメイン知識がないと一筋縄ではいかなかったりします。
また今でこそ情報が集約されてたりQ&Aも整備されて掲載されていますが、法律施行前までは五月雨に情報がアップされて随時変更も加えられていく感じになっています。
システム的には如何に精度高く情報をキャッチアップして、素早く且つ正確にシステムへ反映していくか？が求められます。
日々の運営や請求業務があり、法改正の施行は待ってくれないエンドがずらせないプロジェクトとなります。

次に報酬制度自体が複雑で難解という点です。
一つ一つの支援内容に対して様々な条件の組み合わせによって報酬単位が定まるようになっています。加算だけでなく減算や割合加算もあったりします。
この報酬単位の組み合わせを表したものを報酬算定構造と呼びますが、組み合わせの数が膨大です。
この組み合わせの複雑さもあって請求業務周りの単体テストはNNNNケースほど必要になっています。
また、組み合わせとなるパラメータが法改正によって増減します。システム改修時に報酬算定構造を誤って設計（事前にキャッチアップした情報で行うので厳密には設計ではなく予想に近いですが :sweat_smile: ）を行うと大変なことになります。 ^[正確な情報が出揃ってからシステム改修していては間に合わないという側面があります]

次に、法改正がされても旧制度の対応は維持しつづけないという点が難しいです。
過去行った支援に対しての給付費の請求がもし間違っていた場合に、その時点での報酬制度に応じた再請求を行う必要がある為です。
これはロジックの肥大に直結します。元々扱うドメインが複雑で且つ品質の担保する為のテスト量が多くなっているのに、更に複雑度が上がるのは無理ゲーです。
旧制度に作成したビジネスルールに影響がない形で新しい制度に対応する必要があります。
システム改修を非常に短期間に行う必要があるのは上述の通りですが、新制度だけでも検証するのに手一杯な上、さらに旧制度の検証にどこまで労力を割けるかが課題となります。

## 解決したい課題

法改正の対応の難しさをまとめると以下になります。

1. 期間内で必ず対応が完了することが求められる
業務を止める範囲は限定的且つ短期間である必要がある。
情報が出揃ってからシステム全体の設計 -> 実装を行っていたら間に合わない。
2. 既存の膨大なロジック及びテストケースに条件分岐が発生し、データの互換性を保つことが難しい
報酬算定構造に手をいれないといけないのですが、軽微なルール変更からざっくりルールが廃止されるもの完全新規で追加されるルールがあり、単純に条件分岐で行うとコードの可読性の低下やテストコードのメンテナンスの難易度が上昇します。
またロジックに追従してデータの拡張もどうやっていくのか？という問題がつきまといます。
3. デグレを発生させてはいけない、また品質担保する為のコストを少なくしたい。
QAチームがいますが、システム全体での改修範囲が広く、全て人でカバーすることは難しく品質を担保することができません。
品質を保証させる仕組みが必要となると考えました。

## 課題解決に向けてのアプローチ

運営支援システムはマイクロサービスとして構築しています。構築当初から法改正はある前提で機能毎に責務を明確にしアーキテクチャやドメイン設計に取り組んできました。
特にレセプト業務はコアドメインという位置づけで慎重に分析・設計し、境界づけて実装を行ってきました。
今回の法改正ではレセプト業務の側面からみると新しいビジネスルールが追加するという要件になりますが、上記の課題がありました。
そこでどういうアプローチをしたかを一言でいうと

```
同一の関心事を時系列で分断させ別の関心事として扱う
```

になります。
具体的に言うと旧制度と新制度のレセプト業務のドメインを扱うAPIはそれぞれ別アプリとして存在させることにしました。
旧制度と新制度の切り替えは支援を提供した月によって判断可能です。提供月によってまったく異なるビジネスルールを適用するというイメージとして関心事は分離できるという判断を行いました。
こうすることで上記の課題のうち、2つが解消できました。

* ドメイン自体のコードベースが別になることで条件分岐がなくなりシンプルになる
データも独立して存在するので、既存のデータの拡張を考えなくて済みます
* 旧制度のドメイン・ビジネスルールには手をいれないので、完全に仕様を保ったまま動かし続けることができる
なにも変わらないという安心感は何事にも代えがたいですw
リグレッションテストが最低限で済みます。

コードベースを分けることのメリットは上記ですが、逆にデメリットがないの？と懐疑的になられる方もいらっしゃると思います。
おそらく以下の2点が気になるかと思います。

1. ２重メンテナンスになって辛くならない？
バグ修正や機能追加とかで改修コストが倍になったりしないか？
2. インフラやデプロイコストが２倍にならない？

1点目に関してはまったく問題になっていません。逆に拡張しやすくメンテナンスも楽だとさえ感じています。
それぞれ大丈夫だと考えている理由として以下になります。

1. 十分に責務が絞られて限定的になっているので改修対象とならないことが多い
2. `インフラ・デプロイコスト < 品質担保に関わるコスト` となる

1つ目は理由というよりは前提に近いですが、責務が明確になっており、そうそうロジックに手を入れることがないという点です。
うまく関心事の閉じ込めが出来ているので可能になっている。。綺麗に分割することができる！です。
法改正に関わらない改修で手を入れるというのは、バグやまったく新しい概念が生まれるケース以外では考えられません。
もし改修が必要とするならば余分な責務を持っているという認識です。
日々の機能追加ではほぼ別アプリ側での実装となります。請求業務上で新しい概念を追加する場合でも、スコープを絞って新制度のみの対応で済ますということも出来ます。 ^[実際に、現在開発中の機能で旧制度はスコープ外としました。ビジネスサイドも関心事が別れているという認識を持っているので調整は大変しやすかったですw]
バグ対応についてですが、旧制度のアプリも長い期間運用がされており十分枯れており対応するケースは極稀です。 ^[旧制度の利用は誤請求に対してのみになるので利用頻度も下がります]

繰り返しになりますが関心事が別れてそれぞれのロジックがシンプルになるので、たとえ2重で修正する場合にでもトータルのメンテナンスコストは下がります。
新しいメンバーが増えた時に実感したのですが、旧制度の詳細な内容を把握していなくても、開発をスタートできるというのは大変ありがたいです。

2つ目になりますが、アプリを分割することでデプロイが複雑になりインフラも増えてコストが上がりました。
ただ課題でも上げましたが、 `デグレを発生させてはいけない、また品質担保する為のコスト` という面で考えるとトレードオフの関係になっているという認識です。
この品質担保するコストというのは、今回の法改正対応に限定された話ではなくシステム改修の度に払い続ける必要がものだという認識です。
インフラコストは人が動くコストよりも十分安いです。もしリリースの度に旧制度と新制度ともにリグレッションテストを行うことになったらQAメンバーを今の2倍にしないと難しいです。インフラコストはリグレッションテスト単体を切り出しても十分ペイできます。
テスト期間もそれなりに掛かり開発サイクルにも影響すると考えています。^[もしコードベースが同じだったら普段の開発での単体テストのCI待ち時間も倍増していただろうと思うとゾッとしますw]

## 前編まとめ

実はこのアプローチとコンセプトについては、初期構築からチーム内で方針が既に決まっていました。
実際にアプリを分割してシステム稼働まで行ったのは自分ですが、後編で書くつもりですが形になるまでは色々苦労があったり不安も正直ありました。
ちなみにプロダクトとして大規模な法改正に対応したのは今回が初となります。
今回まとめた内容はそのコンセプトを実現した際に自分なりに感じたことや、振り返って再整理したものとなります。
最初から綺麗に明文化されて課題と目的・手段までが整理されていたわけではありません。
法改正プロジェクトが始まる前の自分自身のシステム全体のドメイン理解が薄かったり、そもそも法改正に対応する経験がなかったりと、なぜマイクロサービスで立ち向かう必要があるのか？しっかりと自認できていなかったと思います。

自分なりに法改正プロジェクトを振り返るとマイクロサービスでなければ、複雑なシステムをこの短期間で乗り切れなかった。またアプローチとしては正解だったと実感しています。
最初にコンセプトを掲げ、責務を明確にしドメインを設計してくれたメンバーに感謝したいと思います。
この複雑な業務を切り出して如何に一つの関心事として閉じ込めるか？という所に心血を注いでくれたおかげで、プロジェクトを乗り越えることができました！


## 最後に

明日もアドカレ続きます。

[@YudaiTsukamoto](https://qiita.com/YudaiTsukamoto) が何か書いてくれます！
