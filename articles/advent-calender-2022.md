---
title: "タイトル未定"
emoji: "🙆"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["microservice","ddd"]
published: true
published_at: 2022-12-14 00:00 
---
:::message
この記事は [LITALICO Engineers Advent Calendar 2022](https://qiita.com/advent-calendar/2022/litalico)の12/14配信になります。
:::

## はじめに

## Litalicoの事業について

LITALICOは「障害のない社会をつくる」というビジョンを掲げ、事業展開している会社です。現在は教育・障害福祉などの領域で、情報メディア、HRサービス、SaaS型業務支援システム、学校向けの支援サポートのソフトウェアなど複数のビジネスモデル・サービスモデルをtoB/toC向けに展開しています。  
主に障害福祉の領域に色々なプロダクトやサービスを展開していますが、障害福祉と一括で説明していますが、実際の支援内容で法律が分かれていたり、多岐に及びます。

* 主に[障害者総合支援法](https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/hukushi_kaigo/shougaishahukushi/service/naiyou.html)  
![障害サービス等の体系1](/images/articles/advent-calender-2022/welfare_service1.png)

* 主に児童福祉法  
![障害サービス等の体系2](/images/articles/advent-calender-2022/welfare_service2.png)

[障害者総合支援法の給付・事業 資料4-1](https://www.mhlw.go.jp/file/06-Seisakujouhou-11130500-Shokuhinanzenbu/0000150448.pdf#page=2)より抜粋 ^[支援する対象者やサービスによって、関連する法律が異なります。]

LITALICOの店舗事業で行っている、就労支援サービス及び障害児通所サービスは障害福祉サービスの一部となり、全てをカバー出来ているわけではありません。


## ビジネス変化に伴いプロダクトを進化させる

昨年のAdvent Calendarで以下の記事を書きました。  

https://zenn.dev/katzumi/articles/confronting-law-amends-with-microservices

こちらは障害児支援事業所さま向けの運営支援サービスでした。  
2020, 2022年とLITALICOグループに新しい2つの会社がJoinしてビジネス変化が生まれました。  
福祉事業所向けの業務支援SaaSプロダクトも2つ増え、LITALICO全体でカバーする障害福祉の領域が広がりました。  
またシステム的に対応する福祉サービスで重複する部分も出てきました。  

前回の記事でも触れましたたが、法改正の対応の難しさは各プロダクトでも同様にあります。  
システムが対応する福祉サービスは種類が違っても全て法律に則って行う必要があり、システム開発時の制約や課題は近いものになります。　　
特にコア業務となるレセプト業務の法改正時の対応のリスクが集中しやすく懸念がありました。

今回の記事は、ビジネス変化に伴い

* プロダクトを進化させる判断を至った理由
* 目指すゴール
* 採用したアーキテクチャ＆開発プロセス
* 開発プロセスを支えるツールや取り組み

をまとめたいと思います。

## 既存レセプトアプリケーションの課題

レセプト業務の主な内容は、支援を行った対価を給付費という形で市区町村等に請求を行う業務になります。　　
支援サービス毎に報酬内容が異なりますが、最終的に市区町村等に請求を行う手順やデータ形式は決まっており、厚生労働省が公開する [インターフェース仕様書](https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/0000174643_00012.html) に記載されている伝送データを作成する必要があります。  

レセプト業務の流れは以下のようになります。

1. 各種支援を行った各種実績（体制状況やサービス利用等）を収集
2. 各種実績を報酬条件を表した報酬算定構造 ^[現物は[こちら](https://www.mhlw.go.jp/content/12200000/000763603.pdf)です。] というものに当てはめて報酬金額のベースとなる単位数を求める
3. 利用者負担額の調整業務
4. 最終的な給付費額を算出し各種帳票（請求書等）と伝送データを出力
5. 給付費の代理受領及び利用者負担額請求

既存アプリケーションでは以下の様な課題がありました。

* 実績データと算定構造が蜜結合に近い状態になっていた
* 算定構造の各種条件をマスターデータとして管理しておりメンテナンスの難易度が高く網羅的にテストの実施が難しい
* 算定構造の条件マッチングが手続き処理が多く、算定構造の実態と乖離してしまっている
* 対応する福祉サービスの追加毎にテーブルが増えて、開発すべき機能数が多い
* 市区町村等へ請求するという関心事以外も業務として扱っている

上記課題があり、

* システム全体の仕様がFixしないとレセプト機能の開発が着手できない
* データフロー的に実績データが登録されないとテストができず、レセプト機能のテストが後回しになってしまう
* マスターデータの妥当性の検証が必須だが、時間的な制約から主要な請求パターンを抜き出してのテストしかできず網羅性を担保できない
* マスターデータの拡張やメンテナンスが職人技過ぎて対応できる人材が限られてしまっている
* 伝送データの仕様が変わった場合に、修正箇所の特定が難しく修正範囲も広い
* 実績管理だけでなく、請求データを利用する後続の処理 ^[利用料請求等] の仕様把握も必要で、対応できる人材の育成に時間がかかりすぎる

という問題がありました。
これらの問題は法改正時のシステム改修を迅速に行うにあたり、かなり辛いものがあります。  
特に上記2つの問題は、開発期間の圧迫や、品質の低下に直結してしまいます。  
レセプト機能は運営支援システムの中で、

* バグ発生時の深刻度が高い
* テストケースの作成には深いドメイン知識が必要
* テストケースの組わせが膨大

という特性があります。
一番テストに時間をかけたい機能ですが、構造上どうしてもテスト開始タイミングが遅くなり期間の余裕がありません。  
レセプトのテストには数多くのマスターデータ及び実績データの登録が必要且つデータの精度がテストの品質に直結するので、致し方ない側面があります。

## コア機能を見定める

昨年に法改正対応した際は対応している支援サービスは3サービスのみで、上記課題があったもののなんとかなりました。  
上述のビジネス変化に伴い最終的には30サービスまで対応数を増やすことになります。また今後の法改正でサービスが増えることが予想されています。  
そうなった場合に、上記の課題は対応する支援サービスが増えるたびに重くのしかかります。レセプト機能の開発者を増やして対応するということも対策として考えられなくもないですが、レセプトのドメイン知識の複雑さから一気に人を増やすこともできないので現実的ではありません。  
支援サービスを30サービスに対応させ、また複数システムを開発・メンテナンスしていくには根本的にやり方を変えないと対応ができないと考えました。　　

ではこの事態にどう立ち向かうかを検討した結果、 `レセプトのコア機能を見定めてBaaS化する` という判断を行いました。

コア機能の見定めるのにまず行ったのは各プロダクトの業務プロセスを整理し、共通となるレセプト業務の洗い出しです。

TODO: 業務プロセス分析の図をはる


伝送データのアウトプットは同じですが、各プロダクトで解決しようとする課題とその扱う領域が異なりました。


コア機能の位置づけは報酬算定と伝送データ（帳票を把握していれば ^[かなりボリュームもあり複雑なので、それだけの仕様を把握するの大変だったりしますがw] 良いのですが

## なぜスキーマ駆動開発を採用したのか？

## スキーマ駆動開発を支える開発プロセス＆ツール群

## 最後に
