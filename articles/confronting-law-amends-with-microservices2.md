---
title: "法改正をマイクロサービスで立ち向かう（後編）"
emoji: "🙆"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["microservice"]
published: false
---
:::message
この記事は [LITALICO Engineers Advent Calendar 2021](https://qiita.com/advent-calendar/2021/litalico)の12/24配信になります。
:::

## はじめに

ボリュームが多くなってしまったので前編・後編の2部構成になり今回は後編となります。
前回の記事は [こちら](https://zenn.dev/katzumi/articles/confronting-law-amends-with-microservices)
Engineers Advent Calendarなのでエンジニア向けの記事になります。

## お題

前回のお話で書いた

```
同一の関心事を時系列で分断させ別の関心事として扱う
```

という、アプローチに対して実際にどう取り組んで実現していったのか？を具体的に検討したことや課題も含めて書きたいと思います。
マイクロサービスの機能分割する際の事例として参考になれば嬉しいと考えています。

1つのアプリケーションを関心事を分けて2つに分割する際の勘所としてまとめられると良いかと考えています。

実現したいイメージは以下になります。
前提としてSPAとして構築しているものとなります。

* As-Is
:::message
TODO
:::
* To-Be
:::message
TODO
:::

## まず考えたこと

今回分割する関心事は元々一つとなります。
アプリが一つあり、そのアプリを複数の別のアプリから呼び出されます。
時系列で処理するアプリを呼び分ける必要があるのですが、まずどうやって呼び分けるか？ということを考えました。

呼び出し元のアプリ側でも同じ時系列のキーは持っており、アプリ（実際にはAPI）を呼び出す際のパラメータを呼び出し元自身で判断して呼び出し先のアプリを変更することは可能です。
ただ以下のシステム特性があり、色々と考慮が必要で方針の検討が必要だと考えました。

* 分割するAPIに対して呼び出し元が多岐にわたる
SPAで構築されており、バックエンドはPHP Laravel、フロントエンドはvue, nuxt(javascript)と言語・フレームワークも複数存在し依存しているアプリの種類も多い ^[各アプリはマイクロサービスとして構築しており関連するチームも多いです]
* 分割されるAPIが今後も増えつづける
３年に一度APIが分割され１つづつ増えていきます
* 新規機能の追加は活発である
分割と同時に新しい機能（API）も出てくる

上記のシステム特性があり、以下を懸念していました。

* 改修範囲が広く、呼び出し元を修正して回るコストが結構かかるのでは？
法改正がメインの改修を行っている最中で、他チームに追加で対応を依頼することになるがそんな余裕があるのだろうか？
* 分割後のアプリがまだ存在しない状態からのスタートで実装が間に合うのか？
分割後のアプリの完成をまってから、呼び出し元の改修〜検証まで行うのは難しいのでは？
* 言語・フレームワークも複数あり対応漏れや品質にばらつきがでてしまうのでは？
まず影響調査から必要になりますが、対応漏れが一番怖いです。対応後の検証もメインの改修でリソースが割かれて余裕はなさそうです。
同じAPI呼び出しでもフロントエンドとバックエンドからで挙動が変わったら嫌すぎます。。
* APIの数自体が多く検証どうやってやろうか？
API数が75ほどあり、分割して改修した後でもロジック的には変わらないものもあったり、正しく呼び分けられているか？を一つづつ確認するのが大変そうです
* 法改正のメイン開発での改修部分に対しての影響や、今後の追加開発での対応漏れが発生してしまうのでは？
今回のアーキテクチャ変更に対して今後のメンテナンスコストも考える必要がありました
* 次の法改正でも同じ対応コストをかけるのか？
また３年後の法改正でバタバタしたくない。今回の対応によっていい感じにしてメンテナンスコストを下げたい

前編で法改正への対応の難しさについてまとめましたが、時間的制約が大きく法改正のメイン開発に着手する前までになんとか見通しを立てたい気持ちでした。


## どうやってAPIを呼び分けるようにするか？

まずAPIの振り分けの責務はどこに持たせるべきか？という点について明確な思いがありました。
今回の関心事として法改正に伴うレセプト業務を扱いますが、

* いつから法改正が施行されるか？
* それを知っているのは誰でその責務を持つのか？

というのが一番大事になってきます。
レセプト業務に関連する各業務に対し、呼び出し元を振り分けるビジネスルールを組み込むことは避けたい。
もし組み込んでしまったらレセプト業務のビジネスルールが別の関心事の領域に滲み出してしまいロジックが分散してしまいます。
また前述のコストや時間的制約の懸念もあり、振り分けルール自体も一つの関心事として切り出しして行える方法を模索しました。

## 検討した振り分け手法

以下の3つの振り分け手法が候補としてありました。

1. 振り分けの為の時系列のキー情報をAPIのエンドポイントURLのパスパラメータとして定義し振り分けを行う
https://example.com/api/rezept/${振分けキー}/calculate
みたいな感じです。ルールベースにすることで、呼び出し元側では裏で動いているアプリケーションは意識しなくて済みます。
パスパラメータであればAmazon API GatewayやNginxのレイヤーでも振分けを行えるメリットがありそうです。
2. 振り分けルールをモジュールとして実装し、各アプリに展開させる
各アプリで共通で利用できるsubmoduleが既にあり、そこのモジュール内にロジックを閉じ込めてしまう方法です。
サービスプロバイダー経由でAPIアクセスさせたり、HTTPクライアントからのAPI通信をhookさせたりできます。
直接APIの呼び出し先を変更するのでパフォーマンスや障害発生ポイントが少ないというメリットがありそうです。
3. Proxyアプリケーションを作成し、そこで振り分けを行わせる
実装をコストがかかりますが柔軟性があります。
ただ、APIの数が75あり法改正対応自体でAPIも増える為、スケジュール的な制約を受けやすそうというデメリットが考えられました。

上記候補で絞り込むのに現状把握を行いました。

* API仕様書を精査
* 呼び出し元のリスト化

こちらの現状把握を行った結果、以下のことがわかりました。

* 単純振分けでは実現できない
大きく分類すると5パターンがあり、それぞれ対応を行う必要がある
* 呼び出し元となる影響をうけるアプリがフロント・バックエンド両方にそれなりにある
影響調査をする前はある程度、想定はしていましたが、やっぱり数が多く多岐に渡っていました。

上記の結果から、以下の方針としました。

```
Proxyアプリケーションを実装する
個別振分けのパターンをそれぞれ実装し、個別振分けのパターン以外については共通の振分けルールとして実装する
```

対応後のイメージとしては以下の様になります

:::message
TODO
:::

新しく追加したアプリ名はレセプトAPIへのルーティングのみを行うので `rezept-router` と命名しました。 ^[責務も明確になっているので個人的に気に入っています]

こちらの構成にすることで、呼び出し元は今まで通り言語やフレームワークに関係なくAPIを呼び出しすることができます。
また呼び出し元の対応も必要最小限で、今後追加されるAPIに対しても対応漏れが発生しづらくなります。
次の法改正でもProxyアプリケーションに振分け先アプリを追加するだけ済みます。

## rezept-routerの実装

rezept-routerで実現する機能としては「リクエストパラメータに含まれる時系列のキー（提供月）を判断してリクエストを振り分ける」です。
この提供月の指定のパターンと、レスポンスの扱いによって振分け処理が異なってきます。
現状把握の結果、APIは以下の５つのパターンに分類されると整理しました。

1. 提供月が一つしか存在せず、単純な振り分け
2. 提供年月が複数にまたがり、更新APIを実行しステータスコードのみ返却する
3. 提供年月が複数にまたがり、レスポンスを統合する必要がある
4. 提供年月が存在せず全バージョンのAPIを呼び出す必要がある
5. 単純に提供年月が存在しない

困ったのが5のパターンです。どうやって振り分けしたら良いのか？判別できません。
ただユースケースの想定としては提供月に関連付けされていて、パラメータとして定義していなかっただけでした。
対応としてはAPIのI/F仕様上のみ提供月を追加し、呼び出し元アプリから提供月をパラメータに付与する様に対応を行いました。
対応の結果、5のパターンが1のパターンとして統合され4つのパターンのみ実装すれば良くなりました。
今後のAPI追加する際のルールとして必ずパラメータに提供年月を含めることとしてチーム内に共有しました。
1のパターンであればrezept-router自身に手を入れなくても対応可能となります。

また、呼び出し元のリスト化した結果、既に使用されていないAPIが存在したがあったので屠り作業を行いました。

上記対応によって、75APIあったのが分類が整理・統廃合されてルーティングの定義は最終的に18種類の実装で済みました。

## rezept-routerへの切り替え

振分けの関心事がうまく切り出しができ、疎結合なシステムとして定義できたので当初懸念していた

* 分割後のアプリがない状態で並行開発ができるか？
* 振分けの動作検証を行えるか？
* 調査漏れ等で対応漏れが発生しないか？

という点がそれぞれ

* 他のアプリへの影響も少なく、並行して開発が進められるようになった
事前リリースも可能でビッグバンリリースにならなくて済みました。
* ルーティングの処理はLaravel APIと実装できたので単体テスト可能になりました
APIのMockは [php-vcr](https://github.com/php-vcr/php-vcr) を利用して実際のレスポンスを使って検証を行いました。
* 呼び出し元はアプリ単位で確認すればよくなった
.envを切り替えるだけなので検証観点の粒度もアプリ単位で済むようになりました。

上記で解消されました。
他の検討した手法に比べてテスタブルで品質を確保して事前リリースでき、切り戻しも簡単になりました。
十分にリスクは下げれたと考えていましたが、リリースは段階リリースとし、併せて以下の対応を追加で行いました。

* 法制度開始前に新アプリを呼び出されるリスクを考慮してエラーになるようにマスターデータ及びバリデーションを追加した
* 逆に法改正開始後に間違ってルーティングされるリスクを考慮して、旧アプリのマスターデータの有効期限を変更した

こうすることで、最悪振分け処理にバグが発生した場合にもエラーで検知でき、データ不整合を防げるようにしました。
関心事を分離してしまったので、関心事以外のリクエストが来た場合にエラーにする必要があります。


## 後編まとめ

前回の記事に書きましたが、アプリ分割の方針は決まっていたものいざ蓋を開けて分割しようとしたら色々と頭を抱えることばかりでした。
関心事を分割する上で検討や配慮が足りなかった点があったと思います。
具体的には上記の振分けパターンの種類が多かった件で、rezept-router視点でいうと一つのAPIで複数の関心事にまたがってしまっていた点です。
フロントエンド側のユーザビリティを向上させる目的になりますが、複数提供月をまたぐ、また提供月関係なく全てのデータを取得するユースケースで1回のリクエストで賄える仕様にしてしまっていました。
フロントエンド側でAPIの呼び出し回数が増えてしまっても提供月単位で処理を行うAPI設計が望ましかったのでは？と思いました。
あと、スペースの問題で詳細は書きませんが、別アプリとデータベースを共有していてそちらのデータの分離も必要でした。
インフラリソースの効率化の為、初期リリース時の判断として共有することとしました。それ自体はよくあることなので問題ないのですが、レセプトアプリで直接別アプリの責務となるデータを直接参照してしまっていたりしました。そちらの処理を本来あるべき姿として別アプリに移植しなおしたりするなどしました。

プロジェクトスタート当初では影響範囲がわからず、不安がありました。
ただAPI呼び出しのトレーサビリティを高める対応を入れたり、今回まとめたような責務の再整理をして切り分けするまで出来たのが良かったと感じています。
ここまで整理してできていれば、次回の法改正では今回よりも安心して望めると思います。

せっかく綺麗に責務が分離できたので、今後の改修では責務をより意識して設計を行っていきたいと思います。

## 全体振り返り

前編・後編とで法改正をマイクロサービスで立ち向かうというテーマで書きましたが、如何だったでしょうか？
複雑なものを関心事という単位に区切って責務を閉じ込めるということを色々な観点で行っているというのが伝われば嬉しく思います。
関心事をどの視点でどう捉えるかによってサービスの切り口が変わってくるという所がマイクロサービスを設計する上で難しいと感じています。
今回も最初は現時点で最適な切り口だと思っていたものが、外部環境の変化（今回は法改正）によって関心事が増えて分割をするという判断をしました。
実際に切り出しする際も将来像を予想しながら行いました。業務のドメイン知識がないと予測も難しいです。

まだ自分自身も手探りで正解はわかっていませんが、今回はある程度はうまくいったのではないかと考えています。
サービスの責務が明確にでき適切に切り分けれることで「各チームがそれぞれの関心事に集中して取り組む」ことができたのではないかな？と思っています。
法改正の対応では五月雨で上がってくる情報をキャッチアップして各チームがそれぞれ影響範囲を考えてアプリの改修を並行で行う必要があります。
関心事の分離が出来ていない責務が曖昧になっていると、安心して並行開発を行うことができません。
複雑かつ時間的制約があるなかでそういう事態となっていたら、法改正に立ち向かえなかったと思います。

## 次の法改正に向けての課題

今回の法改正での振り返りとして課題をまとめておきたいと思います。

* 法制度に関するコアドメインへの影響範囲を特定する作業が属人的すぎる
* 法改正の解釈とそのシステム論点から導き出されたビジネスルールを、プロダクトオーナー・QA・開発メンバーで共通認識できる形での要件定義手法が整備されていない
* 継続的なコンテキストの境界見直し

## 最後に

明日はいよいよ最後です。

SREの[@tjinjin](https://qiita.com/tjinjin)です。
今年7本目（！）となる記事を投稿してくれます。お楽しみに！