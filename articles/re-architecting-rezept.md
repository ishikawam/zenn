---
title: "ビジネス変化に適用するシステムにする為に開発プロセスも進化させた話"
emoji: "🧬"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["アドベントカレンダー","リアーキテクティング","開発プロセス","ddd"]
published: true
published_at: 2022-12-14 00:00
---
:::message
この記事は [LITALICO Engineers Advent Calendar 2022](https://qiita.com/advent-calendar/2022/litalico)の12/14配信になります。
:::

## はじめに

## Litalicoの事業について

LITALICOは「障害のない社会をつくる」というビジョンを掲げ、事業展開している会社です。現在は教育・障害福祉などの領域で、情報メディア、HRサービス、SaaS型業務支援システム、学校向けの支援サポートのソフトウェアなど複数のビジネスモデル・サービスモデルをtoB/toC向けに展開しています。  
主に障害福祉の領域に色々なプロダクトやサービスを展開していますが、障害福祉と一括で説明していますが、実際の支援内容で法律が分かれていたり、多岐に及びます。

* 主に[障害者総合支援法](https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/hukushi_kaigo/shougaishahukushi/service/naiyou.html)  
![障害サービス等の体系1](/images/articles/re-architecting-rezept/welfare_service1.png)

* 主に児童福祉法  
![障害サービス等の体系2](/images/articles/re-architecting-rezept/welfare_service2.png)

[障害者総合支援法の給付・事業 資料4-1](https://www.mhlw.go.jp/file/06-Seisakujouhou-11130500-Shokuhinanzenbu/0000150448.pdf#page=2)より抜粋 ^[支援する対象者やサービスによって、関連する法律が異なります。]

LITALICOの店舗事業で行っている、就労支援サービス及び障害児通所サービスは障害福祉サービスの一部となり、全てをカバー出来ているわけではありません。


## ビジネス変化に伴いプロダクトを進化させる

昨年のAdvent Calendarで以下の記事を書きました。  

https://zenn.dev/katzumi/articles/confronting-law-amends-with-microservices

こちらは障害児支援事業所さま向けの運営支援サービスでした。  
2020, 2022年とLITALICOグループに新しい2つの会社がJoinしてビジネス変化が生まれました。  
福祉事業所向けの業務支援SaaSプロダクトも2つ増え、LITALICO全体でカバーする障害福祉の領域が広がりました。  
またシステム的に対応する福祉サービスで重複する部分も出てきました。  

前回の記事でも触れましたたが、法改正の対応の難しさは各プロダクトでも同様にあります。  
システムが対応する福祉サービスは種類が違っても全て法律に則って行う必要があり、システム開発時の制約や課題は近いものになります。　　
特にコア業務となるレセプト業務の法改正時の対応のリスクが集中しやすく懸念がありました。

今回の記事は、ビジネス変化に伴い

* プロダクトを進化させる判断を至った理由
* 目指すゴール
* 採用したアーキテクチャ＆開発プロセス
* 開発プロセスを支えるツールや取り組み

をまとめたいと思います。

## 既存レセプトアプリケーションの課題

レセプト業務の主な内容は、支援を行った対価を給付費という形で市区町村等に請求を行う業務になります。　　
支援サービス毎に報酬内容が異なりますが、最終的に市区町村等に請求を行う手順やデータ形式は決まっており、厚生労働省が公開する [インターフェース仕様書](https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/0000174643_00012.html) に記載されている伝送データを作成する必要があります。  

レセプト業務の流れは以下のようになります。

1. 各種支援を行った各種実績（体制状況やサービス利用等）を収集
2. 各種実績を報酬条件を表した報酬算定構造 ^[現物は[こちら](https://www.mhlw.go.jp/content/12200000/000763603.pdf)です。] というものに当てはめて報酬金額のベースとなる単位数を求める
3. 利用者負担額の調整業務
4. 最終的な給付費額を算出し各種帳票（請求書等）と伝送データを出力
5. 給付費の代理受領及び利用者負担額請求

既存アプリケーションでは以下の様な課題がありました。

* 実績データと算定構造が蜜結合に近い状態になっていた
* 算定構造の各種条件をマスターデータとして管理しておりメンテナンスの難易度が高く網羅的にテストの実施が難しい
* 算定構造の条件マッチングが手続き処理が多く、算定構造の実態と乖離してしまっている
* 対応する福祉サービスの追加毎にテーブルが増えて、開発すべき機能数が多い
* 市区町村等へ請求するという関心事以外も業務として扱っている

上記課題があり、

* システム全体の仕様がFixしないとレセプト機能の開発が着手できない
* データフロー的に実績データが登録されないとテストができず、レセプト機能のテストが後回しになってしまう
* マスターデータの妥当性の検証が必須だが、時間的な制約から主要な請求パターンを抜き出してのテストしかできず網羅性を担保できない
* マスターデータの拡張やメンテナンスが職人技過ぎて対応できる人材が限られてしまっている
* 伝送データの仕様が変わった場合に、修正箇所の特定が難しく修正範囲も広い
* 実績管理だけでなく、請求データを利用する後続の処理 ^[利用料請求等] の仕様把握も必要で、対応できる人材の育成に時間がかかりすぎる

という問題がありました。
これらの問題は法改正時のシステム改修を迅速に行うにあたり、かなり辛いものがあります。  
特に上記2つの問題は、開発期間の圧迫や、品質の低下に直結してしまいます。  
レセプト機能は運営支援システムの中で、

* バグ発生時の深刻度が高い
* テストケースの作成には深いドメイン知識が必要
* テストケースの組わせが膨大

という特性があります。
一番テストに時間をかけたい機能ですが、構造上どうしてもテスト開始タイミングが遅くなり期間の余裕がありません。  
レセプトのテストには数多くのマスターデータ及び実績データの登録が必要且つデータの精度がテストの品質に直結するので、致し方ない側面があります。

## コア機能を見定める

昨年に法改正対応した際は対応している支援サービスは3サービスのみで、上記課題があったもののなんとかなりました。  
上述のビジネス変化に伴い最終的には34サービスまで対応数を増やすことになります。また今後の法改正でサービスが増えることが予想されています。  
そうなった場合に、上記の課題は対応する支援サービスが増えるたびに重くのしかかります。レセプト機能の開発者を増やして対応するということも対策として考えられなくもないですが、レセプトのドメイン知識の複雑さから一気に人を増やすこともできないので現実的ではありません。  
支援サービスを34サービスに対応させ、また複数システムを開発・メンテナンスしていくには根本的にやり方を変えないと対応ができないと考えました。　　

どう立ち向かうかを検討した結果、 `レセプトのコア機能を見定めてBaaS化` してリアーキテクティングを行う判断を行いました。

コア機能の見定めるのにまず行ったのは各プロダクトの業務プロセスを整理し、共通となるレセプト業務の洗い出しです。以下の様にデータフロー的に大まかな業務をまとめてマッピングしました。

![業務プロセス分析](/images/articles/re-architecting-rezept/business_process.png)


伝送データのアウトプットは同じですが、各プロダクトで解決しようとする課題とその扱う領域の範囲が異なりました。  
業務プロセスの精査の結果、コア機能を以下に注目して絞ることにしました

* 報酬算定
* 利用者負担の金額調整＆給付費計算
* 給付費請求書出力＆伝送データ出力

上述のレセプト業務の流れの2〜4までとなります。　　
業務の抽象度をより上げてレセプト業務の責務を再定義しました。  
こうすることで関心事が報酬算定と伝送データのみに向き合うだけでよくなります。^[それでもかなりボリュームもあり複雑なので、仕様を把握するの大変だったりしますがw]  
各プロダクトの実績データや個別の業務要件に依存させずに請求プラットフォームとして独立化させます。


## 目指すゴール

請求プラットフォームとして独立化させて以下のことを実現させることをゴールとしました。

* 独立したシステムとして関心事が明確になり、平行開発してプロダクト全体のアジリティを上げる【主目的】  
請求プラットフォームも含めたプロダクト全体の法改正対応の着手タイミングを前倒しする
* 確保した時間で十分な検証を行えるようにして品質を担保する【超重要！リスク低減】  
独立化したサービスとして各プロダクトとの結合前に検証できる仕組みも構築する
* 同じ関心事を共通のシステムで実現して効率化を図る【副次効果】  

BaaS化は共通化に伴うシステム開発のコスト削減は主目的ではなく、法改正を高品質且つ迅速に対応する為に行うものとしました。

## 請求プラットフォームをどのように設計していったか？

まずは大まかに整理した業務プロセスからユースケースとしてまとめてインタフェースをまとめました。

![ユースケース](/images/articles/re-architecting-rezept/usecase.png)

上記でまとめたインターフェースをBaaSのAPIとしてまとめるにあたり肝になるのが、請求データの元となる各種データをどの様にAPIのパラメータに落とし込むか？という所です。  
幸いなことにLITALICOグループ内で、請求データを効率よく作る為のデータ構造のノウハウと実績があった為、そちらをベースに各プラットフォームの要件のニーズに合わせてアレンジしてAPIとして実装しました。APIがドメイン知識を集約して体現するものになります。今後の法改正時にも向き合っていくことになるので慎重に設計をする様に心がけました。

## 採用した開発プロセス

請求プラットフォームとなるBaaSを開発するにあたり、スキーマ駆動開発を採用しました。  
請求プラットフォームの実装が完了してから各プロダクトの連携部分を実装していたら法改正に間に合いません。  
請求データの元となる各種データのスキーマをまず設計して、インターフェースを公開して並行開発を行うフローとしました。  
API仕様書を記述するフォーマットとしてOpenAPI V3を採用しました。  
対応する支援サービス毎にAPIが増えていきます。 ^[最終的にはエンドポイントが100オーバーになる予定]  
スキーマとして基本的な項目が共通としてあり、Components Objectを使って再利用して書きたかったのと、スキーマ自体が複雑 ^[jsonの要素数がリクエスト・レスポンス共に50〜100程度。大きいものだと200ぐらいあります] なので記述力があるOpenAPI V3で書きました。

## スキーマ駆動開発を支える開発プロセス＆ツール群

複雑度がある数多くのAPIのスキーマを定義し、それらをSpec通りに実装していくにはかなり大変です。又、BaaSなのでQAチームがそのままではテストができません。あと複数チームと連携して並行開発する形になるので開発フロー等の整備が必要だと考えました。  

実際に取り込みを行なった内容は以下の通りです。

* 実装と乖離させないスキーマ駆動開発フローの整備  
* APIシナリオテストの導入  
* バージョン管理・リリースフローの整備

今回は記事のスペース的に具体的な取り組みの内容について取り上げることが出来ません。  
具体的な取り組みやHowについては別記事でまとめています。  
以降で個別に記事の紹介と、取り組みの理由（Why）と実践してみてどうだったか？を補足させて頂きます。


## 実装と乖離させないスキーマ駆動開発フローの整備

https://zenn.dev/katzumi/articles/schema-driven-development-flow

APIの仕様が複雑化するのは目に見えていたのと、法改正時に数多くのAPIを一度に修正するのでレビューが大変になると思いました。
OpenAPI自体はjsonやyamlで記述可能でGitHub上でレビューは可能ですが、一つの大きいファイルをレビューしてもミスに気づけないだろうと考えました。  
OpenAPIのSpecを分割する方法もありますが、色々辛いです。  
そもそもOpenAPIの経験のないメンバーが多いので生のOpenAPI仕様書を書くのも難しいだろうなーと考えました。  
プロジェクト開始時にOpenAPI関連のツールを [調べまくっていました](https://zenn.dev/katzumi/scraps/6fc1213caa5586)。色々記事を調べながら感じたことは開発プロセスに組み込まないと難しいだろうなーという感想でした。  
仕様書を先に書いて、後追いで実装するスタイルだと絶対に実装と仕様が乖離していくぞと。  
色々試しながら、たどり着いたのが記事の開発フローになります  
SpecからValidationやRoutingが自動生成される様になって、Controllerテストで大量のパラメータチェックのテストを書かなくても済むようになって、かなり助かっています。  
Schame通りになっているか？もテストツールに組み入れらてチェックされているので、安心感も違います。  
APIのI/Fの品質が手間なく担保されることで、ロジックに集中できるようになりました。  

今回のプロジェクトの話から外れますが、社内の他のプロジェクトで、API仕様書を書く文化がなかったチームにも同じ開発プロセスを布教しました。  
すんなり受け入れられた様で、API仕様書を当たり前に書く様になって自分の考え方は間違っていなかったと感じました。  

あと個人的にはOSSへも貢献 ^[こちらの[PR](https://github.com/zircote/swagger-php/pull/1303)]　もできて良かったです。  PHP8.1でのAttributeの活用方法を理解できたのとAPI仕様でEnumを多様するので記述量を減らすことができました。  


## APIシナリオテストの導入

https://zenn.dev/katzumi/articles/api-scenario-testing-with-runn

BaaSなのでAPIしかなくテストどうしよう？というと所からのスタートでした。  
各プロダクトからBaaSへの連携が完了してから、システムテストを行うのであれば結局以前とあまり変わらないのでなんとしてもAPIテストを実現しようと考えていました。  
OpenAPIを使うことは決めていたので、親和性の高いツールを探していました。  
APIは請求データを管理する為のコードを発行して、そのコードを次のAPIに引き渡しをして呼び出していくスタイルになっています。  
API単体のテストではなく、シナリオを書けるツールが必要でした。
その時にrunnの記事を見つけて、コレだ！と確信して直ぐに試してみました。  
最初はrunnの不具合でテストがうまく動かなかったのですがシナリオの書き味が良く、可能性を感じました。  
runnはgolangで開発されていますが、プラットフォームの一部のサービスでgolangで開発し始めていたこともあり、ものは試しにコードを見てみたら修正できそうだったのでPullRequestしました。直ぐに取り込んで頂き無事に使えるようになりました。  
その当時はrunnの開発初期ということもあり、機能とコード量もそれほど多くなかったのでいくつかの提案とPullRequestを送らせて頂きました。
その後にcollaboratorに招待をして頂き、templateによるデータ生成やデータ駆動テストの仕組みをディスカッションしながらrunnに組み込んで頂きました。  
json読み込み（templateによるjson生成）とデータ駆動テストの仕組みは、リクエストとレスポンスが複雑なのでどうしても欲しかった機能でした。  
請求パターンの組み合わせが膨大にあり ^[一つの支援サービスで数千オーダーになります。請求の最小単位となるサービスコードの種類]、一つのテストケースでリクエストとその期待値のレスポンスを管理するうえでシナリオに直接データを埋め込むのは現実ではありませんでした。  

Controllerテストも含めて単体テストを書いていますが、リクエストとレスポンスが複雑なこともあり、テストの実装効率はよく有りません。runnのシナリオテストではデータの準備から含めて記述することができるので大変効率良く記載できている印象です。  
既にプロジェクトメンバー全員がシナリオを作成できるようになっており、APIを実装したら必ずシナリオテストを書くサイクルになっています。現在、シナリオ数とデータ駆動のテストパターンをあわせると100ケースは超えています。今後もデータ駆動のパターンを中心にどんどんケースが増える予定です。  
請求データを作成するのに7つぐらいのAPIを呼び出す感じになるのですが、runnのrunbookのinclude機能によるシナリオ再利用ができており、コード量もそこまで増えていません。  

QAチームがテスト設計したデータパターンを事前に共有してもらい、それをシナリオテストに組み込んで事前検証を行えるようになっています。
それ以外にもrunnによりAPIシナリオテストを導入して良かったことは

* Controllerテストでは発見できなかったAPIの仕様バグを発見できる
* ユースケース単位でシナリオを書くことでAPIの挙動がドキュメントとしてまとまる
* APIの冪等性担保のテストが簡単にできる
* コミット毎にリグレッションテストがされる安心感がある
* deploy後の動作検証もコマンド一つで完了する
* APIテストだけでは確認できないDBの状態チェックができる
* 非同期処理を行うAPIの後続処理もExec Runnerを使えばカバーできる

等々、期待以上の効果を実感しておりプロジェクトになくてはならないツールとなりました。  

こちらの要望に対してより良いアイデアの提案やコア機能の改善をしていただいた [@k1LoW](https://twitter.com/k1LoW) さんにはこの場を借りて感謝をお伝えしたいと思います。


## バージョン管理・リリースフローの整備

https://zenn.dev/katzumi/articles/introducing-tagpr-to-backend-as-a-service


runnの開発時にtagprによるバージョン管理を体験した経験から、プロジェクトにマッチしそうと思って導入しました。  
API仕様書が日々変化するなかで、他チームとの共通認識できるバージョンを付けたかったというのが目的になります。
導入してみて感想となりますが

* 他チームとの共有がRelease noteのURLを教えるだけで良くなった
* Release作業をチームの垣根を超えて任せられるようになった

となります。
特に後者は色々側面がありますが

`関係者全員に最低限のコミュニケーションでバージョンを共有できる`

というのが大きいかと考えています。  
開発あるあるですが、プロジェクト全体を把握している人がリリース担当になってしまいがち問題を解消できたのが良かったです。  
調整を行うのに頭のリソースの一部を専有していたのが、次にリリースする内容が自明になって、各メンバーが自立的に調整する流れになったのが大変ありがたいです。

`リリース作業の民主化`

がされたといっていいのでしょうか？
簡単に導入できるので、是非試してみて頂きたいです。
スキーマ駆動開発にはバージョン管理はmustにしても良いくらいと個人的に考えています。

## 複雑な法律に立ち向かい迅速な開発を目指す

ここまでスキーマ駆動開発における取り組みを紹介しましたが、それ以外でも法改正に迅速に対応するべき行なっている内容を軽く触れたいと思います。

* 請求の関心事に特化したフレームワークを構築  
複雑な請求業務ですが、大きな処理の流れは同じになります。  
支援サービス固有のロジックと、共通部分を見定めてうまくドメインに切り出しして設計を行いました。関心事を関連するドメインに閉じ込めることで、全ての業務ルールを理解してなくても開発できるようになります。  
複雑な業務ルールを抽象化してモデリングを丁寧にして、フレームワークとして使えることを目指しました。
* 算定構造を型で表現する  
以前は算定構造にある算定項目はデータベースのテーブルのカラムとして表現されていました。各種実績データを算定構造に当てはめて計算を行うのですが、条件を検索する処理が手続きとして実装されていました。  
算定構造 `表` を扱うのに実装が手続き処理が多く、実装とモデルとの間に差がうまれてしまっていました。一つの条件を見直すのに処理を追わないと修正ができません。  
今回は算定構造を明確なドメインとして設計して型を組み合わせて表現するようにしました。  
型の組み合わせで請求パターンを表現できるようになり、以前は一部の請求パターンのみしかテスト出来なかったものを型の組み合わせを自動生成して網羅的にテストを行えるようになりました。  
型を組み合わせて表を作るだけでよくなり、関心事が集約されました。
* 手続き処理をなるべく排除してルールベースで機能するようにする
[@t-konta](https://qiita.com/t-konta) さんが記事でまとめてくれています。

https://qiita.com/t-konta/items/4071cf36eb2c38d6f76e

法改正対応時に手数を減らす意味で、なるべく手続きをなくしルールベースで処理がされるようにします。手続きがない分テストの範囲も限られれます。  
またデータのプロパティも数多く存在するので、データとルールがセットで見れるとレビューも大変しやすいし、コードを追いやすいです。  
PHP8.1からのAttributeはドメインにルールを埋め込むのがしやすく大変良いと感じています。


## 最後に

最後までお読み頂いてありがとうございます！  
色々な取り組みをしていますが、その背景を知って貰えたら嬉しく思います。  
どの取り組みも課題を解決する為の一つのアイデアですが、背景を再整理してより良いアイデアが生まれたらと思い記事にしました。  
リアーキテクティングはまだ道途中ですが、今後も開発プロセスもいい感じにしていきたいと思います。

:::message
明日は、[LITALICO Engineers Advent Calendar 2022](https://qiita.com/advent-calendar/2022/litalico) 15日目の記事です。[@megumi-ok](https://qiita.com/megumi-ok) さんがが担当してくれます。どうぞお楽しみに！
:::
